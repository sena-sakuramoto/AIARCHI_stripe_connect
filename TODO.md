# TODO / 課題リスト

## 要デプロイ

### GASの更新（サブスク会員AI FES.自動登録）
`gas/webhook.gs` に以下の機能を追加しました。GASを再デプロイしてください。

**新機能：サブスク入会時にAI FES. Zoom自動登録**
- サブスク入会 = AI FES.無料参加確定として処理
- 購入手続き不要でZoom自動登録 + 参加URL送信
- 会員特典メールで「登録完了」を案内

**変更された入会フロー:**
```
[サブスク入会]
    ↓
[Discord連携案内メール送信]
    ↓
[AI FES. Zoom自動登録（4会議すべて）]
    ↓
[AI FES.参加案内メール送信（Zoom URL付き）]
```

**送信されるメール:**
1. **Discord連携案内メール** - 新規入会時に自動送信
2. **AI FES.参加案内メール** - Zoom URL付き、購入不要のお知らせ
3. **未連携者リマインド** - 24時間以上未連携の会員に（既存）

#### GASデプロイ手順
1. GASエディタで `gas/webhook.gs` の内容をコピー＆ペースト
2. スクリプトプロパティを設定：
   - GASエディタ → ⚙️「プロジェクトの設定」→「スクリプトプロパティ」
   - 以下のプロパティを追加（値は.envファイル参照）：
     - `SCHEDULER_TOKEN`
     - `ZOOM_ACCOUNT_ID`
     - `ZOOM_CLIENT_ID`
     - `ZOOM_CLIENT_SECRET`
     - `STRIPE_SECRET_KEY`
3. 「デプロイを管理」→「編集」→「新しいバージョン」→「デプロイ」
4. 時間ベースのトリガーを設定：
   - 「トリガー」→「トリガーを追加」
   - 関数: `sendUnlinkedReminders`
   - 時間ベースのトリガー: 日タイマー（毎日9:00など）

---

## 完了済み

### Discordロール付与導線の改善（2026-01-21）
- [x] 購入完了→即Discord OAuth画面へ自動リダイレクト
- [x] OAuth完了後のページをモダンなデザインに改善
- [x] メールアドレスでDiscord連携できる `/link` エンドポイント追加
- [x] 新規入会時にDiscord連携案内メールを送信（GAS）
- [x] 未連携者検出API `/admin/unlinked-customers` を追加
- [x] 未連携者へのリマインドメール機能（GAS）

**改善された購入フロー:**
```
[決済完了] → [Discord OAuth画面] → [連携完了ページ] → [サーバー参加]
                                        ↓
                              @proロール自動付与
```

**フォールバック（見逃した場合）:**
- 入会時にDiscord連携案内メールが届く
- 24時間経過してもも未連携 → リマインドメールが届く
- `/link` ページからメールアドレスで連携可能

### 学生価格の自動適用（2026-01-21）
- .ac.jp / .edu / .ed.jp ドメインで自動的に¥2,000/月
- LIVE環境に価格作成済み、デプロイ済み

### 領収書の会社名対応（2026-01-20）
- 購入時に会社名入力欄追加
- 入力された会社名が領収書の宛名になる
